<!DOCTYPE html>
<html>
  <head>
    <title>Monitor</title>
    <style>
      video {
        width: 100%;
        max-width: 720px;
        background: black;
      }
      .status {
        padding: 5px 10px;
        border-radius: 4px;
        display: inline-block;
        margin-left: 10px;
      }
      .connected {
        background-color: #4caf50;
        color: white;
      }
      .disconnected {
        background-color: #f44336;
        color: white;
      }
    </style>
  </head>

  <body>
    <h1>
      Monitor
      <span id="connectionStatus" class="status disconnected"
        >Disconnected</span
      >
    </h1>
    <video id="remoteVideo" autoplay playsinline muted></video>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // Connection state management
      let peer = null;
      let clientSocketId = null;
      let reconnecting = false;
      const connectionStatus = document.getElementById("connectionStatus");

      // Check if we have a previous session
      const previousSocketId = localStorage.getItem("monitorSocketId");

      // Initialize socket connection
      const socket = io();

      // Send role with previous ID if available
      socket.emit("role", "monitor", previousSocketId);

      // Store current socket ID for reconnection
      socket.on("connect", () => {
        console.log("ðŸ”Œ Socket connected, ID:", socket.id);
        localStorage.setItem("monitorSocketId", socket.id);
      });

      const remoteVideo = document.getElementById("remoteVideo");

      // Function to set up WebRTC connection
      function setupWebRTCConnection(clientId) {
        console.log("ðŸ†• Setting up connection to client:", clientId);
        clientSocketId = clientId;
        connectionStatus.textContent = "Connecting...";

        // Store client ID for reconnection
        localStorage.setItem("connectedToClient", clientId);

        // Create new peer connection if needed
        if (
          !peer ||
          peer.connectionState === "closed" ||
          peer.connectionState === "failed"
        ) {
          peer = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
          });
          console.log("ðŸ”„ Created RTCPeerConnection");

          // Set up media handlers
          peer.ontrack = (event) => {
            const stream = event.streams[0];
            console.log("ðŸ“¡ Stream received:", stream);
            remoteVideo.srcObject = stream;
            remoteVideo.onloadedmetadata = () => {
              console.log("â–¶ï¸ Playing video");
              remoteVideo.play();
            };
          };

          // Set up connection state change handlers
          peer.oniceconnectionstatechange = () => {
            console.log("ðŸ’¡ ICE connection state:", peer.iceConnectionState);
            if (
              peer.iceConnectionState === "connected" ||
              peer.iceConnectionState === "completed"
            ) {
              connectionStatus.textContent = "Connected";
              connectionStatus.className = "status connected";
            } else if (
              peer.iceConnectionState === "disconnected" ||
              peer.iceConnectionState === "failed"
            ) {
              connectionStatus.textContent = "Disconnected";
              connectionStatus.className = "status disconnected";
            }
          };

          peer.onconnectionstatechange = () => {
            console.log("ðŸ”— Connection state:", peer.connectionState);
          };
        }

        // Set up ICE candidate handling
        peer.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("ðŸ§Š ICE candidate:", event.candidate);
            socket.emit("ice-candidate", {
              target: clientSocketId,
              candidate: event.candidate,
            });
          }
        };

        // Request an offer from the client
        console.log("ðŸ“¤ Sending offer request");
        socket.emit("offer-request", {
          monitorSocketId: socket.id,
        });
      }

      // Handle new client connection
      socket.on("new-client", (clientId) => {
        console.log("ðŸ†• New client:", clientId);
        setupWebRTCConnection(clientId);
      });

      // Handle offer from client
      socket.on("offer", ({ sender, offer }) => {
        console.log("ðŸ“¥ Received offer from:", sender);
        clientSocketId = sender;

        // Store client ID for reconnection
        localStorage.setItem("connectedToClient", sender);

        if (peer) {
          peer
            .setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => {
              console.log("ðŸ“ Creating answer");
              return peer.createAnswer();
            })
            .then((answer) => {
              console.log("ðŸ“ Setting local description");
              return peer.setLocalDescription(answer);
            })
            .then(() => {
              console.log("ðŸ“¤ Sending answer to client");
              socket.emit("answer", {
                target: sender,
                answer: peer.localDescription,
              });
            })
            .catch((err) => {
              console.error("âŒ Error creating or sending answer:", err);
            });
        } else {
          console.error(
            "âŒ Received offer but peer connection not initialized"
          );
          // Try to set up connection
          setupWebRTCConnection(sender);
        }
      });

      // Handle ICE candidates from client
      socket.on("ice-candidate", ({ candidate }) => {
        console.log("ðŸ§Š Received ICE candidate");
        if (peer) {
          peer
            .addIceCandidate(new RTCIceCandidate(candidate))
            .then(() => {
              console.log("âœ… Added ICE candidate successfully");
            })
            .catch((err) => {
              console.error("âŒ Error adding ICE candidate:", err);
            });
        } else {
          console.error(
            "âŒ Received ICE candidate but peer connection not initialized"
          );
        }
      });

      // Handle disconnection and reconnection
      socket.on("disconnect", () => {
        console.log("ðŸ”Œ Socket disconnected");
        connectionStatus.textContent = "Disconnected";
        connectionStatus.className = "status disconnected";

        // Don't close the peer connection immediately to allow for refresh reconnection
      });

      socket.on("reconnect", () => {
        console.log("ðŸ”„ Socket reconnected");
        // Re-register role with previous ID
        socket.emit("role", "monitor", previousSocketId);

        // Try to reconnect to the same client if we were connected before
        const lastClientId = localStorage.getItem("connectedToClient");
        if (lastClientId) {
          console.log(
            "ðŸ”„ Attempting to reconnect to previous client:",
            lastClientId
          );
          setupWebRTCConnection(lastClientId);
        }
      });

      // Handle page visibility changes to manage reconnection
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          console.log("ðŸ”Œ Page became visible, checking connection...");
          // If we have a peer connection but it's disconnected, try to reconnect
          if (
            peer &&
            (peer.iceConnectionState === "disconnected" ||
              peer.connectionState === "disconnected")
          ) {
            console.log(
              "ðŸ”„ Connection was disconnected, attempting to reconnect..."
            );
            const lastClientId = localStorage.getItem("connectedToClient");
            if (lastClientId) {
              setupWebRTCConnection(lastClientId);
            }
          }
        }
      });

      // Attempt to reconnect when the window is focused
      window.addEventListener("focus", () => {
        console.log("ðŸ”Œ Window focused, checking connection...");
        if (
          peer &&
          (peer.iceConnectionState === "disconnected" ||
            peer.connectionState === "disconnected")
        ) {
          console.log(
            "ðŸ”„ Connection was disconnected, attempting to reconnect..."
          );
          const lastClientId = localStorage.getItem("connectedToClient");
          if (lastClientId) {
            setupWebRTCConnection(lastClientId);
          }
        }
      });
    </script>
  </body>
</html>

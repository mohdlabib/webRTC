<!DOCTYPE html>
<html>
  <head>
    <title>Monitor</title>
    <style>
      video {
        width: 100%;
        max-width: 720px;
        background: black;
      }
    </style>
  </head>

  <body>
    <h1>Monitor</h1>
    <video id="remoteVideo" autoplay playsinline muted></video>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      socket.emit("role", "monitor");

      const remoteVideo = document.getElementById("remoteVideo");
      let peer;
      let clientSocketId;

      socket.on("new-client", (clientId) => {
        console.log("üÜï New client:", clientId);
        clientSocketId = clientId;

        peer = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });
        console.log("üîÑ Created RTCPeerConnection");

        peer.ontrack = (event) => {
          const stream = event.streams[0];
          console.log("üì° Stream received:", stream);
          remoteVideo.srcObject = stream;
          remoteVideo.onloadedmetadata = () => {
            console.log("‚ñ∂Ô∏è Playing video");
            remoteVideo.play();
          };
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("üßä ICE candidate:", event.candidate);
            socket.emit("ice-candidate", {
              target: clientSocketId,
              candidate: event.candidate,
            });
          }
        };

        peer.oniceconnectionstatechange = () => {
          console.log("üí° ICE connection state:", peer.iceConnectionState);
        };

        peer.onconnectionstatechange = () => {
          console.log("üîó Connection state:", peer.connectionState);
        };

        console.log("üì§ Sending offer request");
        socket.emit("offer-request", {
          monitorSocketId: socket.id,
        });
      });

      socket.on("offer", ({ sender, offer }) => {
        console.log("üì• Received offer from:", sender);
        clientSocketId = sender;
        peer
          .setRemoteDescription(new RTCSessionDescription(offer))
          .then(() => {
            console.log("üìù Creating answer");
            return peer.createAnswer();
          })
          .then((answer) => {
            console.log("üìù Setting local description");
            return peer.setLocalDescription(answer);
          })
          .then(() => {
            console.log("üì§ Sending answer to client");
            socket.emit("answer", {
              target: sender,
              answer: peer.localDescription,
            });
          })
          .catch((err) => {
            console.error("‚ùå Error creating or sending answer:", err);
          });
      });

      socket.on("ice-candidate", ({ candidate }) => {
        console.log("üßä Received ICE candidate");
        peer
          .addIceCandidate(new RTCIceCandidate(candidate))
          .then(() => {
            console.log("‚úÖ Added ICE candidate successfully");
          })
          .catch((err) => {
            console.error("‚ùå Error adding ICE candidate:", err);
          });
      });
    </script>
  </body>
</html>

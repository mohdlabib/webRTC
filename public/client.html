<!DOCTYPE html>
<html>
  <head>
    <title>Client</title>
  </head>

  <body>
    <h1>Client (Camera)</h1>
    <video id="localVideo" autoplay playsinline muted></video>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      socket.emit("role", "client");

      const localVideo = document.getElementById("localVideo");
      let peer;

      let monitorSocketId = null;

      socket.on("monitor-available", (id) => {
        console.log("ðŸ“¡ Monitor available:", id);
        monitorSocketId = id;

        peer = new RTCPeerConnection({
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        });
        console.log("ðŸ”„ Created RTCPeerConnection");

        navigator.mediaDevices
          .getUserMedia({
            video: true,
            audio: false,
          })
          .then((stream) => {
            console.log("âœ… Got media stream:", stream);
            localVideo.srcObject = stream;
            stream.getTracks().forEach((track) => {
              console.log("âž• Adding track to peer connection:", track.kind);
              peer.addTrack(track, stream);
            });

            peer.onicecandidate = (event) => {
              if (event.candidate) {
                console.log("ðŸ§Š ICE candidate:", event.candidate);
                socket.emit("ice-candidate", {
                  target: monitorSocketId,
                  candidate: event.candidate,
                });
              }
            };

            peer
              .createOffer()
              .then((offer) => {
                console.log("ðŸ“ Created offer");
                return peer.setLocalDescription(offer);
              })
              .then(() => {
                console.log("ðŸ“¤ Sending offer to monitor");
                socket.emit("offer", {
                  target: monitorSocketId,
                  offer: peer.localDescription,
                });
              })
              .catch((err) => {
                console.error("âŒ Error creating or sending offer:", err);
              });
          })
          .catch((err) => {
            console.error("âŒ Error accessing camera:", err.name, err.message);
            alert("Error accessing camera: " + err.message);
          });

        socket.on("answer", ({ answer }) => {
          console.log("ðŸ“¥ Received answer from monitor");
          peer
            .setRemoteDescription(new RTCSessionDescription(answer))
            .then(() => {
              console.log("âœ… Set remote description successfully");
            })
            .catch((err) => {
              console.error("âŒ Error setting remote description:", err);
            });
        });

        socket.on("ice-candidate", ({ candidate }) => {
          console.log("ðŸ§Š Received ICE candidate");
          peer
            .addIceCandidate(new RTCIceCandidate(candidate))
            .then(() => {
              console.log("âœ… Added ICE candidate successfully");
            })
            .catch((err) => {
              console.error("âŒ Error adding ICE candidate:", err);
            });
        });

        peer.oniceconnectionstatechange = () => {
          console.log("ðŸ’¡ ICE connection state:", peer.iceConnectionState);
        };

        peer.onconnectionstatechange = () => {
          console.log("ðŸ”— Connection state:", peer.connectionState);
        };
      });

      socket.emit("get-monitor");

      socket.on("offer-request", ({ monitorSocketId }) => {
        console.log("ðŸ“¥ Received offer request from monitor:", monitorSocketId);
        if (!peer && monitorSocketId) {
          console.log(
            "ðŸ”„ Setting up peer connection in response to offer request"
          );
          socket.emit("monitor-available", monitorSocketId);
        }
      });
    </script>
  </body>
</html>
